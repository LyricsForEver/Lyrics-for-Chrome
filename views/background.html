<script src="../javascripts/zepto.min.js"></script>
<script>
  var newLyricsTabId = -1;
  
  function getLyrics(title, callback) {
    var startPos, endPos, lyrics;
    
    $.get('http://google.com/search?sourceid=navclient&btnI=1&q=site%3Aazlyrics.com+' + encodeURIComponent(title), function(data, status){
      try {
      
        // Check if XHR completed succesfully
        if(status !== 'success'){
          throw('Could not connect with azlyrics');
        }
        
        startPos = data.indexOf('<!-- start of lyrics -->') + 26,
        endPos = data.indexOf('<!-- end of lyrics -->'),
        lyrics = data.substr(startPos, endPos - startPos);
        
        if(lyrics.length === 0){
          throw('No lyrics found');
        }
        
        // Send lyrics back
        callback({
          success: true,
          lyrics: lyrics
        });
      } catch(err) {
      
        // Error in request
        callback({
          success: false,
          errorMsg: err
        });            
      }
    });
  }
  
  function onInstall() {
  
  }

  function onUpdate() {
  
  }
  
  function getVersion() {
    var manifest, xhr = new XMLHttpRequest();
        
    xhr.open('GET', chrome.extension.getURL('manifest.json'), false);
    xhr.send(null);
    manifest = JSON.parse(xhr.responseText);
    return manifest.version;
  }
  
  function onLyricsTabPrepared(tab, callback){
    newLyricsTabId = tab.id;
      
    // Keep track of the lyrics tab
    chrome.tabs.onRemoved.addListener(function(tabId, removeInfo){
      if(newLyricsTabId === tabId){
        newLyricsTabId = -1;
      }
    });
    
    // Create a temporary listener to check when the tab content has loaded
    chrome.tabs.onUpdated.addListener(function(tabId, changeInfo, tab) {
      if(changeInfo.status === "complete" && tab.id === newLyricsTabId) {
        callback.call();
        chrome.tabs.onUpdated.removeListener(arguments.callee);
      }
    });
  }
  
  function convertTabToLyricsTab(tabId, callback){
    var options = {
      url: chrome.extension.getURL('../contentScripts/newTab/index.html')
    };
    
    chrome.tabs.update(tabId, options, function(newTab){
      onLyricsTabPrepared(newTab, callback);
    });
  }
  
  function createLyricsTab(index, callback){
    var options = {
      url: chrome.extension.getURL('../contentScripts/newTab/index.html')
    };
    
    if(index !== -1){
      options.index = index;
    }
    
    chrome.tabs.create(options, function(newTab){
      onLyricsTabPrepared(newTab, callback);
    });
  }
  
  function openLyricsInTab(title, index){
    // Request for the lyrics tab
    var submitRequest = function(){
      chrome.tabs.sendRequest(newLyricsTabId, {
        title: title,
        onlyRequery: true,
        action: 'initNewTab'
      }, function(res){
        console.log('test', res, chrome.extension.lastError);
      });
    };
    
    if(newLyricsTabId === -1){
      // Create a new tab for the lyrics
      createLyricsTab(index, submitRequest);
    } else {
      // Make the tab selected
      chrome.tabs.update(newLyricsTabId, {selected: true});
      
      // The lyrics tab already exists
      submitRequest();
    }
  }
  
  // Omnibox default suggestion
  chrome.omnibox.setDefaultSuggestion({description: 'Enter the song title and artist or a part of the lyrics'});
  
  // If input has been sent via the omnibox
  chrome.omnibox.onInputEntered.addListener(function(title) {
    chrome.tabs.getSelected(null, function(tab){
      
      // Check if you're already in the lyrics tab
      if(newLyricsTabId === tab.id){
        openLyricsInTab(title);
      }
      
      // Set the lyrics tab to the current tab`
      convertTabToLyricsTab(tab.id, function(){
        openLyricsInTab(title);
      });
    });
  });
  
  chrome.extension.onRequest.addListener(function(request, sender, callback) {
    switch(request.action){
      case 'newTabPageLoaded':
        
      break;
      case 'getLyrics':
        getLyrics(request.title, callback);
      break;
      case 'showPageActionIcon':
        chrome.pageAction.show(sender.tab.id);
      break;
    }
  });
  
  // Send a message to the tab if the page action was clicked
  chrome.pageAction.onClicked.addListener(function(tab){
  
    if(localStorage['showLyricsType'] == 'onPage'){
    
      // Show the lyrics on the current tab itself
      chrome.tabs.sendRequest(tab.id, {action: 'showLyricsOnPage'});
    } else {
    
      // Get the title from the page
      chrome.tabs.sendRequest(tab.id, {action: 'getLyricsTitle'}, function(data){
        openLyricsInTab(data.title, tab.index+1);
      });
    }
  });
  
  // Check if the extension has been updated
  var currVersion = getVersion(),
      prevVersion = localStorage['version'];
      
  if (currVersion !== prevVersion) {
    if (typeof prevVersion === 'undefined') {
      onInstall();
    } else {
      onUpdate();
    }
    
    localStorage['version'] = currVersion;
  }
  
  // Check if is set whether the lyrics should show up on the page or in a new tab
  if(typeof localStorage['showLyricsType'] === 'undefined'){
    localStorage['showLyricsType'] = 'onPage';
  }
</script>
